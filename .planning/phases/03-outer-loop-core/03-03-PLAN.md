---
phase: 03-outer-loop-core
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - .gitattributes
  - bin/ralph.sh
  - bin/lib/display.sh
autonomous: false

must_haves:
  truths:
    - ".gitattributes enforces LF line endings for shell scripts"
    - "Color output respects NO_COLOR environment variable"
    - "ralph.sh works on both Unix and Windows Git Bash"
  artifacts:
    - path: ".gitattributes"
      provides: "Line ending configuration"
      contains: "*.sh text eol=lf"
    - path: "bin/lib/display.sh"
      provides: "NO_COLOR-aware color definitions"
      contains: "NO_COLOR"
  key_links:
    - from: "bin/ralph.sh"
      to: "bin/lib/display.sh"
      via: "color variables"
      pattern: "RED|GREEN|YELLOW|CYAN"
---

<objective>
Ensure cross-platform compatibility by configuring line endings, adding NO_COLOR support, and verifying behavior on different platforms.

Purpose: GSD Lazy Mode must work on Unix and Windows (via Git Bash). This plan addresses the cross-platform pitfalls identified in research: line endings, color handling, and path differences.

Output: ralph.sh that works reliably on both Unix and Windows systems with proper terminal output handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-outer-loop-core/03-CONTEXT.md
@.planning/phases/03-outer-loop-core/03-RESEARCH.md
@.planning/phases/03-outer-loop-core/03-02-SUMMARY.md
@bin/ralph.sh
@bin/lib/display.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add .gitattributes for line ending control</name>
  <files>.gitattributes</files>
  <action>
Create or update `.gitattributes` in project root:

```
# Shell scripts must use LF line endings (Unix style)
# This prevents "bad interpreter" errors on Unix when files
# are edited on Windows and committed with CRLF
*.sh text eol=lf

# Markdown files can use native line endings
*.md text

# Keep these binary
*.png binary
*.jpg binary
*.gif binary
```

After creating the file:
1. Run `git add .gitattributes`
2. Normalize existing shell scripts: `git add --renormalize bin/*.sh bin/lib/*.sh`

This ensures all .sh files in the repo use LF endings regardless of what OS commits them.
  </action>
  <verify>
Run: `cat .gitattributes` - should show *.sh eol=lf rule
Run: `file bin/ralph.sh` - should show "ASCII text" not "with CRLF line terminators"
  </verify>
  <done>
.gitattributes exists with LF enforcement for shell scripts. Existing scripts are normalized.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add NO_COLOR support to display.sh and ralph.sh</name>
  <files>bin/lib/display.sh, bin/ralph.sh</files>
  <action>
1. **Update bin/lib/display.sh** - Replace hardcoded colors with NO_COLOR check:

At the top of the file, replace the color definitions with:
```bash
# Check for NO_COLOR (https://no-color.org/)
if [[ -n "${NO_COLOR:-}" ]]; then
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    BOLD=''
    RESET=''
else
    RED='\e[31m'
    GREEN='\e[32m'
    YELLOW='\e[33m'
    CYAN='\e[36m'
    BOLD='\e[1m'
    RESET='\e[0m'
fi
```

2. **Update bin/ralph.sh** - Ensure spinner uses colors from display.sh:

The spinner already sources display.sh, so it should use $CYAN and $RESET variables.
Verify the spinner printf uses these variables (not hardcoded escape codes).

If ralph.sh has any hardcoded color codes, replace them with the variables from display.sh.

3. **Update other lib files** that define their own colors:
- bin/lib/budget.sh has BUDGET_RED, etc.
- bin/lib/state.sh has STATE_RED, etc.
- bin/lib/failfast.sh has RED, GREEN, etc.

For each, add the NO_COLOR check pattern at the top, OR source display.sh and use its variables.

Recommended: Source display.sh at the top of each lib file and use its color variables instead of defining duplicates. This centralizes color management.
  </action>
  <verify>
Run: `NO_COLOR=1 ./bin/ralph.sh` - should show no ANSI escape codes in output
Run: `./bin/ralph.sh` - should show colored output normally
Run: `grep -r "\\\\e\[" bin/` - should only find them inside NO_COLOR conditional blocks
  </verify>
  <done>
All color output respects NO_COLOR environment variable. Colors centralized in display.sh. No hardcoded escape codes outside conditionals.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
ralph.sh outer loop with:
- STATE.md parsing and task detection
- Claude CLI invocation with JSON output
- Spinner display during execution
- Failure handling with Retry/Skip/Abort menu
- State updates on success
- Cross-platform line endings
- NO_COLOR support
  </what-built>
  <how-to-verify>
**On your current system:**
1. Run `./bin/ralph.sh --help` or just `./bin/ralph.sh`
2. Verify startup summary displays (config, position, next task)
3. Verify spinner appears and cleanup works (Ctrl+C should not leave spinner running)
4. If Claude CLI configured: verify it attempts to execute the next plan
5. Run `NO_COLOR=1 ./bin/ralph.sh` - verify no color codes in output

**If you have access to Windows with Git Bash:**
1. Clone/pull the repo
2. Run `./bin/ralph.sh` in Git Bash
3. Verify no "bad interpreter" or line ending errors
4. Verify spinner displays correctly (ASCII chars only)

**Expected behavior:**
- Startup shows config summary
- Spinner shows [N/MAX] Running XX-YY... with rotating |/-\
- On failure: menu with r/s/a options
- On success: logs to ralph.log, updates STATE.md
- Ctrl+C cleanly stops with no orphan processes
  </how-to-verify>
  <resume-signal>Type "approved" if working on your system, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. .gitattributes exists with *.sh eol=lf
2. All shell scripts have LF line endings (no CRLF)
3. NO_COLOR=1 produces no ANSI escape codes
4. Normal execution shows colored output
5. Human verified working on at least one platform
6. If Windows tested: confirmed working in Git Bash
</verification>

<success_criteria>
- .gitattributes enforces LF for *.sh files
- NO_COLOR environment variable respected by all output
- Colors centralized in display.sh
- ralph.sh verified working by human tester
- No "bad interpreter" errors possible from line ending issues
- Phase 3 requirements LOOP-01 and LOOP-02 are complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-outer-loop-core/03-03-SUMMARY.md`
</output>
