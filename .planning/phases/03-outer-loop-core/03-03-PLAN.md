---
phase: 03-outer-loop-core
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/display.sh
  - .gitattributes
autonomous: true

must_haves:
  truths:
    - "Colors are disabled when NO_COLOR environment variable is set"
    - "Spinner uses ASCII-only characters (works in Git Bash)"
    - "Shell scripts have LF line endings enforced via .gitattributes"
    - "Scripts work on Unix and Windows (Git Bash)"
  artifacts:
    - path: "bin/lib/display.sh"
      provides: "NO_COLOR support and cross-platform spinner"
      contains: "NO_COLOR"
    - path: ".gitattributes"
      provides: "Line ending enforcement for shell scripts"
      contains: "*.sh text eol=lf"
  key_links:
    - from: "bin/lib/display.sh"
      to: "NO_COLOR"
      via: "environment variable check"
      pattern: "\\$\\{NO_COLOR"
---

<objective>
Add cross-platform compatibility: NO_COLOR support and line ending enforcement.

Purpose: Ensures ralph.sh works correctly on both Unix and Windows (Git Bash) with proper terminal output behavior.
Output: Updated display.sh with NO_COLOR support and spinner, plus .gitattributes for line endings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-outer-loop-core/03-CONTEXT.md
@.planning/phases/03-outer-loop-core/03-RESEARCH.md

# File to modify
@bin/lib/display.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NO_COLOR support to display.sh</name>
  <files>bin/lib/display.sh</files>
  <action>
Update bin/lib/display.sh to respect the NO_COLOR standard (https://no-color.org/).

**Replace the color code definitions at top of file:**

Before (current):
```bash
RED='\e[31m'
GREEN='\e[32m'
YELLOW='\e[33m'
CYAN='\e[36m'
BOLD='\e[1m'
RESET='\e[0m'
```

After (with NO_COLOR check):
```bash
# Respect NO_COLOR standard (https://no-color.org/)
if [[ -n "${NO_COLOR:-}" ]]; then
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    BOLD=''
    RESET=''
else
    RED='\e[31m'
    GREEN='\e[32m'
    YELLOW='\e[33m'
    CYAN='\e[36m'
    BOLD='\e[1m'
    RESET='\e[0m'
fi
```

This ensures all output functions (show_progress, show_status, format_duration) automatically adapt.
  </action>
  <verify>
```bash
# Test with NO_COLOR set
NO_COLOR=1 source bin/lib/display.sh
echo "RED='$RED'"  # Should be empty

# Test without NO_COLOR
unset NO_COLOR
source bin/lib/display.sh
echo "RED='$RED'"  # Should be '\e[31m'
```
  </verify>
  <done>display.sh respects NO_COLOR environment variable</done>
</task>

<task type="auto">
  <name>Task 2: Add cross-platform spinner to display.sh</name>
  <files>bin/lib/display.sh</files>
  <action>
Add spinner functions to display.sh for showing progress during Claude execution:

**Add at end of file:**

```bash
# =============================================================================
# Spinner Functions (Cross-Platform)
# =============================================================================

# Spinner state
SPINNER_PID=""

# start_spinner - Start background spinner with message
# Args: message
# Uses ASCII-only characters for Git Bash compatibility
start_spinner() {
    local message="$1"

    # ASCII-only spinner characters (works everywhere)
    local spin_chars='|/-\'

    # Don't start spinner if not a terminal
    if [[ ! -t 1 ]]; then
        echo "$message"
        return 0
    fi

    # Disable job control messages
    set +m 2>/dev/null || true

    {
        local i=0
        while true; do
            local char="${spin_chars:$i:1}"
            printf "\r${CYAN}%s %s${RESET}" "$message" "$char"
            i=$(( (i + 1) % 4 ))
            sleep 0.25
        done
    } &

    SPINNER_PID=$!

    # Re-enable job control
    set -m 2>/dev/null || true
}

# stop_spinner - Stop the background spinner
# Cleans up spinner process and clears line
stop_spinner() {
    if [[ -n "$SPINNER_PID" ]]; then
        kill "$SPINNER_PID" 2>/dev/null || true
        wait "$SPINNER_PID" 2>/dev/null || true
        SPINNER_PID=""
        # Clear the spinner line
        printf "\r\033[2K"
    fi
}

# Ensure cleanup on script exit
trap 'stop_spinner' EXIT
```

**Key cross-platform considerations:**
- Use ASCII only: `|/-\` (no Unicode spinners)
- Check if stdout is terminal before starting spinner
- Use `|| true` after set commands for POSIX compatibility
- Proper process cleanup with trap
  </action>
  <verify>
```bash
source bin/lib/display.sh

# Test spinner (visual)
start_spinner "Testing spinner..."
sleep 2
stop_spinner
echo "Spinner stopped"
```
  </verify>
  <done>display.sh provides start_spinner/stop_spinner with ASCII characters that work on Git Bash</done>
</task>

<task type="auto">
  <name>Task 3: Create .gitattributes for line ending enforcement</name>
  <files>.gitattributes</files>
  <action>
Create .gitattributes at repository root to enforce LF line endings for shell scripts.

This prevents the common Windows issue where CRLF line endings cause "bad interpreter" errors.

**File content:**

```
# GSD Ralph - Line ending normalization
# Ensures shell scripts work on both Unix and Windows (Git Bash)

# Shell scripts must use LF line endings
*.sh text eol=lf

# Other common text files - auto-detect but normalize on commit
*.md text
*.json text
*.yaml text
*.yml text
*.txt text

# Keep binary files as-is
*.png binary
*.jpg binary
*.gif binary
```

**After creating the file, normalize existing files:**
```bash
git add .gitattributes
git add --renormalize .
```

This will convert any existing CRLF endings in tracked .sh files to LF.
  </action>
  <verify>
```bash
# Verify .gitattributes exists and has sh rule
grep '*.sh text eol=lf' .gitattributes && echo "Rule exists"

# Check line endings of a shell script (should show LF)
file bin/lib/display.sh  # Should NOT mention CRLF
```
  </verify>
  <done>.gitattributes enforces LF line endings for all shell scripts</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `NO_COLOR=1 source bin/lib/display.sh && show_status "test" "success"` shows no color codes
2. Spinner runs with ASCII characters: `source bin/lib/display.sh && start_spinner "test" && sleep 1 && stop_spinner`
3. `.gitattributes` exists with `*.sh text eol=lf` rule
4. Shell scripts have LF line endings (no CRLF)
</verification>

<success_criteria>
- NO_COLOR environment variable disables all color output
- Spinner uses ASCII-only characters (|/-\)
- Spinner cleans up properly on exit (no orphan processes)
- .gitattributes enforces LF line endings for *.sh files
- Scripts remain functional on both Unix and Windows
</success_criteria>

<output>
After completion, create `.planning/phases/03-outer-loop-core/03-03-SUMMARY.md`
</output>
