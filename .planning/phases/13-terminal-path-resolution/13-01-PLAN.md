---
phase: 13-terminal-path-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/lib/terminal-launcher.js
autonomous: true

must_haves:
  truths:
    - "wt.exe launches Git Bash regardless of user's Windows Terminal default profile"
    - "User with Scoop/Chocolatey/custom Git install sees autopilot spawn correctly"
    - "User without Git Bash at any location sees graceful fallback to cmd.exe"
    - "User sees actionable error message when no suitable terminal found"
  artifacts:
    - path: "bin/lib/terminal-launcher.js"
      provides: "Multi-location Git Bash detection with cmd.exe fallback"
      exports: ["launchTerminal", "findTerminal", "findGitBash"]
      contains: "GIT_BASH_CANDIDATES"
  key_links:
    - from: "launchWindowsTerminal()"
      to: "findGitBash()"
      via: "function call"
      pattern: "findGitBash\\(\\)"
    - from: "findTerminal()"
      to: "launchCmd()"
      via: "fallback when wt.exe returns null"
      pattern: "return null"
---

<objective>
Harden terminal-launcher.js to handle Windows environments where Git Bash is not at the standard path or where wt.exe would spawn a non-Git-Bash shell.

Purpose: Users with Scoop, Chocolatey, or custom Git installations currently see autopilot fail because wt.exe assumes Git Bash is at `C:\Program Files\Git\bin\bash.exe`. This plan implements multi-location search and graceful fallback.

Output: Modified bin/lib/terminal-launcher.js with findGitBash() function and wt.exe -> cmd.exe fallback chain
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-terminal-path-resolution/13-RESEARCH.md

# The file to modify
@bin/lib/terminal-launcher.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add findGitBash() with multi-location search</name>
  <files>bin/lib/terminal-launcher.js</files>
  <action>
Add the `fs` require at the top of the file (after `const path = require('path')`):

```javascript
const fs = require('fs');
```

Add GIT_BASH_CANDIDATES constant and findGitBash() function after the existing toGitBashPath() function (around line 27):

```javascript
// Common Git Bash installation locations (order: most common first)
const GIT_BASH_CANDIDATES = [
  'C:\\Program Files\\Git\\bin\\bash.exe',           // Standard 64-bit
  'C:\\Program Files (x86)\\Git\\bin\\bash.exe',     // Standard 32-bit
  'C:\\Git\\bin\\bash.exe',                          // Custom root install
  path.join(process.env.USERPROFILE || '', 'scoop', 'apps', 'git', 'current', 'bin', 'bash.exe'), // Scoop user
  'C:\\ProgramData\\scoop\\apps\\git\\current\\bin\\bash.exe'  // Scoop global
];

/**
 * Find Git Bash executable by checking multiple candidate locations
 * @returns {string|null} Path to bash.exe if found, null otherwise
 */
function findGitBash() {
  for (const candidate of GIT_BASH_CANDIDATES) {
    try {
      if (fs.existsSync(candidate)) {
        return candidate;
      }
    } catch (e) {
      continue;
    }
  }
  return null;
}
```

This covers TERM-01 (existence check) and TERM-02 (multiple locations).
  </action>
  <verify>
- `node -c bin/lib/terminal-launcher.js` shows no syntax errors
- `node -e "const t = require('./bin/lib/terminal-launcher.js'); console.log('fs loaded')"` succeeds
  </verify>
  <done>findGitBash() function exists and checks 5 candidate locations for Git Bash</done>
</task>

<task type="auto">
  <name>Task 2: Modify launchWindowsTerminal to use findGitBash and signal fallback</name>
  <files>bin/lib/terminal-launcher.js</files>
  <action>
Modify the launchWindowsTerminal() function (and its Node variant) to:
1. Call findGitBash() instead of hardcoding the path
2. Return null if Git Bash not found (signals findTerminal to try next terminal)

Replace the existing launchWindowsTerminal function with:

```javascript
function launchWindowsTerminal(scriptPath, windowTitle = 'GSD') {
  const gitBashPath = findGitBash();

  if (!gitBashPath) {
    // Git Bash not found - signal to findTerminal() to try next terminal
    return null;
  }

  const cwd = process.cwd();
  const bashScript = toGitBashPath(scriptPath);
  const bashCwd = toGitBashPath(cwd);

  return spawn('wt.exe', [
    '--title', windowTitle,
    gitBashPath, '--login', '-c', `cd "${bashCwd}" && bash "${bashScript}"`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

Replace the existing launchWindowsTerminalNode function with:

```javascript
function launchWindowsTerminalNode(scriptPath, windowTitle = 'GSD') {
  const gitBashPath = findGitBash();

  if (!gitBashPath) {
    // Git Bash not found - signal to findTerminal() to try next terminal
    return null;
  }

  const cwd = process.cwd();
  const bashScript = toGitBashPath(scriptPath);
  const bashCwd = toGitBashPath(cwd);

  return spawn('wt.exe', [
    '--title', windowTitle,
    gitBashPath, '--login', '-c', `cd "${bashCwd}" && node "${bashScript}" "${bashCwd}"`
  ], {
    detached: true,
    stdio: 'ignore',
    cwd: cwd,
    shell: false
  });
}
```

This implements TERM-01 (existence check before launch) by returning null when Git Bash not found, which enables TERM-03 (fallback).
  </action>
  <verify>
- `node -c bin/lib/terminal-launcher.js` shows no syntax errors
- `grep "findGitBash()" bin/lib/terminal-launcher.js` shows usage in both launcher functions
  </verify>
  <done>launchWindowsTerminal() uses findGitBash() and returns null when Git Bash not found</done>
</task>

<task type="auto">
  <name>Task 3: Update findTerminal to handle launcher null returns and add exports</name>
  <files>bin/lib/terminal-launcher.js</files>
  <action>
Modify findTerminal() to handle the case where a launcher returns null (signaling "try next terminal"):

Replace the existing findTerminal function with:

```javascript
function findTerminal(platform) {
  const terminals = TERMINAL_CONFIG[platform] || [];

  for (const terminal of terminals) {
    try {
      if (commandExistsSync(terminal.name)) {
        return terminal;
      }
    } catch (err) {
      continue;
    }
  }

  return null;
}
```

The findTerminal function itself doesn't need changes - the null return handling happens in launchTerminal().

Modify launchTerminal() to handle launcher returning null:

Find the try block in launchTerminal() and update it to handle null:

```javascript
  try {
    // Resolve absolute path - each launcher handles its own path format conversion
    const ralphPath = path.join(os.homedir(), '.claude', 'get-shit-done', 'bin', 'ralph.sh');
    const subprocess = terminal.launcher(ralphPath, 'GSD Ralph');

    // If launcher returns null (e.g., wt.exe when Git Bash not found), try next terminal
    if (subprocess === null) {
      // Find next available terminal after current one
      const terminals = TERMINAL_CONFIG[platform] || [];
      const currentIndex = terminals.findIndex(t => t.name === terminal.name);

      for (let i = currentIndex + 1; i < terminals.length; i++) {
        try {
          if (commandExistsSync(terminals[i].name)) {
            const fallbackSubprocess = terminals[i].launcher(ralphPath, 'GSD Ralph');
            if (fallbackSubprocess !== null) {
              fallbackSubprocess.unref();
              console.log(`\nLaunched ralph.sh in new ${terminals[i].name} window (fallback from ${terminal.name})`);

              // Launch progress watcher in second terminal
              const watcherResult = launchProgressWatcher();

              console.log('You can now close this Claude session - ralph.sh will continue running.\n');

              return {
                success: true,
                terminal: terminals[i].name,
                pid: fallbackSubprocess.pid,
                watcherPid: watcherResult.success ? watcherResult.pid : null,
                fallbackFrom: terminal.name
              };
            }
          }
        } catch (fallbackErr) {
          continue;
        }
      }

      // No fallback terminal worked
      console.log(`\n${terminal.name} unavailable (Git Bash not found) and no fallback terminal available\n`);
      showManualInstructions(platform);
      return {
        success: false,
        reason: 'launcher_returned_null',
        attemptedTerminal: terminal.name
      };
    }

    subprocess.unref(); // Critical: allow parent to exit independently

    console.log(`\nLaunched ralph.sh in new ${terminal.name} window`);

    // Launch progress watcher in second terminal
    const watcherResult = launchProgressWatcher();

    console.log('You can now close this Claude session - ralph.sh will continue running.\n');

    return {
      success: true,
      terminal: terminal.name,
      pid: subprocess.pid,
      watcherPid: watcherResult.success ? watcherResult.pid : null
    };
  } catch (err) {
```

Add findGitBash to module.exports:

```javascript
module.exports = {
  launchTerminal,
  findTerminal,  // Exported for testing
  findGitBash,   // Exported for testing
  showManualInstructions  // Exported for direct use if needed
};
```

This implements TERM-03 (cmd.exe fallback), ERR-01 (clear error message), and ERR-02 (manual instructions already exist).
  </action>
  <verify>
- `node -c bin/lib/terminal-launcher.js` shows no syntax errors
- `node -e "const t = require('./bin/lib/terminal-launcher.js'); console.log(typeof t.findGitBash)"` prints "function"
- `grep "fallbackFrom" bin/lib/terminal-launcher.js` shows fallback tracking in return object
  </verify>
  <done>launchTerminal() handles null from launcher and falls back to next available terminal with clear error messages</done>
</task>

</tasks>

<verification>
1. `node -c bin/lib/terminal-launcher.js` - no syntax errors
2. `node -e "const t = require('./bin/lib/terminal-launcher.js'); console.log(t.findGitBash())"` - returns path or null
3. `grep -c "GIT_BASH_CANDIDATES" bin/lib/terminal-launcher.js` - returns 1
4. `grep "fallback" bin/lib/terminal-launcher.js` - shows fallback logic
5. Module loads: `node -e "require('./bin/lib/terminal-launcher.js')"`
</verification>

<success_criteria>
- [ ] fs module imported at top of file
- [ ] GIT_BASH_CANDIDATES array contains 5 locations (standard, x86, custom, scoop user, scoop global)
- [ ] findGitBash() function exists and is exported
- [ ] launchWindowsTerminal() calls findGitBash() instead of hardcoded path
- [ ] launchWindowsTerminal() returns null when Git Bash not found
- [ ] launchTerminal() handles null return and falls back to next terminal
- [ ] Error messages include attempted terminal and fallback info
- [ ] No syntax errors in module
</success_criteria>

<output>
After completion, create `.planning/phases/13-terminal-path-resolution/13-01-SUMMARY.md`
</output>
